create DATABASE QLNV
USE QLNV
GO
CREATE TABLE NHANVIEN
(
MANV INT NOT NULL,
HONV NCHAR(10), 
TENLOT NCHAR(20),
TENNV NCHAR(10),
NGSINH date,
DCHI NCHAR(35),
PHAI Nchar(4),
LUONG INT,
MA_NQL INT,
PHG SMALLINT NOT NULL
)

CREATE TABLE PHONGBAN
(
MAPHG SMALLINT NOT NULL,
TENPHG CHAR(20),
TRPHG INT NOT NULL,
NG_NHANCHUC DATE
)

 CREATE TABLE DIADIEM_PHG
 (
 MAPHG SMALLINT NOT NULL, 
 DIADIEM CHAR(20) NOT NULL
 )
 
 CREATE TABLE DEAN
 (
 MADA SMALLINT NOT NULL,
 TENDA NCHAR(20),
 DDIEM_DA CHAR(20),
 PHONG SMALLINT NOT NULL,
 )
 
 CREATE TABLE PHANCONG
 (
 MA_NVIEN INT NOT NULL,
 SODA SMALLINT NOT NULL,
 THOIGIAN FLOAT
 )
 
 CREATE TABLE THANNHAN
 (
 MA_NVIEN INT NOT NULL,
 TENTN NCHAR(20) NOT NULL,
 PHAI NCHAR(4),
 NGSINH DATE,
 QUANHHE NCHAR(15)
 )
DROP TABLE DIADIEM_PHG
DROP TABLE THANNHAN
EXEC sp_tables--XEM CÁC BẢNG VÙA TẠO

--TẠO KHÓA CHÍNH 
--mỗi bảng chỉ có duy nhat 1 khoa s chính 
ALTER TABLE NHANVIEN ADD CONSTRAINT M_NV PRIMARY KEY (MANV) 
ALTER TABLE PHONGBAN ADD CONSTRAINT MA_PHG PRIMARY KEY (MAPHG) 
ALTER TABLE DIADIEM_PHG ADD CONSTRAINT MA_DIADIEM PRIMARY KEY (MAPHG,DIADIEM) 
ALTER TABLE DEAN ADD CONSTRAINT MA_DA PRIMARY KEY (MADA) 
ALTER TABLE PHANCONG ADD CONSTRAINT MA_PC PRIMARY KEY (MA_NVIEN,SODA) 
ALTER TABLE THANNHAN ADD CONSTRAINT MA_TN PRIMARY KEY (MA_NVIEN,TENTN) 
--chưa tạo được khóa dẹ quy từ MAQL->MANV
--XEM KHÓA CÍNH CÁC BẢNG
 EXEC sp_pkeys DIADIEM_PHG
 exec sp_pkeys NHANVIEN
 exec sp_pkeys PHONGBAN
 exec sp_pkeys DIADIEM_PHG
 exec sp_pkeys DEAN
 exec sp_pkeys PHANCONG
 exec sp_pkeys THANNHAN

 -- XÓA RÀNG BUỘC QUAN HỆ 
 ALTER TABLE NHANVIEN DROP M_NV
 ALTER TABLE PHONGBAN DROP MA_PHG
 ALTER TABLE DIADIEM_PHG DROP MA_DIADIEM
 ALTER TABLE DEAN DROP MA_DA
 ALTER TABLE PHANCONG DROP MA_PC
 ALTER TABLE THANNHAN DROP MA_TN
 --TAO LIEN KET
ALTER TABLE PHONGBAN ADD CONSTRAINT F_MA_NQL FOREIGN  KEY (TRPHG) REFERENCES  NHANVIEN ON DELETE CASCADE ON UPDATE CASCADE
ALTER TABLE PHANCONG ADD CONSTRAINT F_MA_NV FOREIGN  KEY (MA_NVIEN) REFERENCES  NHANVIEN ON DELETE CASCADE ON UPDATE CASCADE
ALTER TABLE THANNHAN ADD CONSTRAINT F_MA_NV_TN FOREIGN  KEY (MA_NVIEN) REFERENCES  NHANVIEN ON DELETE CASCADE ON UPDATE CASCADE
ALTER TABLE NHANVIEN ADD CONSTRAINT F_PHG_NV FOREIGN  KEY (PHG) REFERENCES  PHONGBAN 

ALTER TABLE DIADIEM_PHG ADD CONSTRAINT F_PHG_DDP FOREIGN  KEY (MAPHG) REFERENCES  PHONGBAN ON DELETE CASCADE ON UPDATE CASCADE
ALTER TABLE DEAN ADD CONSTRAINT F_PHG_DA FOREIGN  KEY (PHONG) REFERENCES  PHONGBAN ON DELETE CASCADE ON UPDATE CASCADE
ALTER TABLE PHANCONG ADD CONSTRAINT F_S_DA FOREIGN  KEY (SODA) REFERENCES  DEAN 
ALTER TABLE NHANVIEN ADD CONSTRAINT F_MA_NQL FOREIGN  KEY (MA_NQL) REFERENCES  NHANVIEN 

-- chon rang buoc
alter table NHANVIEN check constraint all
alter table PHONGBAN check constraint all
alter table DIADIEM_PHG check constraint all
alter table DEAN check constraint all
alter table PHANCONG check constraint all
alter table THANNHAN check constraint all

-- BOchon rang buoc
alter table NHANVIEN nocheck constraint all
alter table PHONGBAN nocheck constraint all
alter table DIADIEM_PHG nocheck constraint all
alter table DEAN nocheck constraint all
alter table PHANCONG nocheck constraint all
alter table THANNHAN nocheck constraint all

set dateformat dmy--CAIF DAT NHAP NGAY THANG NAM

--NHAP DU LIEU CHO TUNG BANG
INSERT INTO NHANVIEN VALUES (123456789,N'Dinh',N'Ba',N'Tien','09/01/1955','120 Tran Hung Dao, Q1, TPHCM',N'Nam',30000,333445555,5)
INSERT INTO NHANVIEN VALUES (333445555,N'Nguyen',N'Thanh',N'Tung','08/12/1945','12 Nguyen Van Cu, Q5, TPHCM',N'Nam',40000,888665555,5)
INSERT INTO NHANVIEN VALUES (999887777,N'Bui',N'Thuy',N'Vu','19/07/1958','60 Nguyen Trai, Q1, TPHCM',N'Nam',25000,987654321,4)
INSERT INTO NHANVIEN VALUES (987654321,N'Le',N'Thi',N'Nhan','20/06/1931','203 Ho Van Hue ,QPN, TPHCM',N'Nu',43000,888665555,4)
INSERT INTO NHANVIEN VALUES (666884444,N'Nguyen',N'Manh',N'Hung','15/09/1952','45 Le Loi, Ba Ria-Vung Tau',N'Nam',38000,333445555,5)
INSERT INTO NHANVIEN VALUES (453453453,N'Tran',N'Thanh',N'Tam','31/07/1962','90 Le Loi, Q1, TPHCM',N'Nam',25000,333445555,5)
INSERT INTO NHANVIEN VALUES (987987987,N'Tran',N'Hong',N'Quang','29/03/1959','21 Ly Thai To, Q10, TPHCM',N'Nam',25000,987654321,4)
INSERT INTO NHANVIEN VALUES (888665555,N'Vuong',N'Ngoc',N'Quyen','10/10/1927','250 Trung Vuong, Ha Noi',N'Nu',55000,null,1)--NUGU
INSERT INTO NHANVIEN VALUES (111111111,N'NGUYEN',N'THANH',N'BINH','10/10/1927','250 Trung Vuong, Ha Noi',N'Nu',55000,null,1)--NUGU


INSERT INTO PHONGBAN VALUES (5,N'Nghien cuu',333445555,'22/05/1978')
INSERT INTO PHONGBAN VALUES(4,N'Dieu hanh',987987987,'01/01/1971')
INSERT INTO PHONGBAN VALUES(1,N'Quan ly',888665555,'19/06/1971')

INSERT INTO DIADIEM_PHG VALUES(1,N'TPHCM')
INSERT INTO DIADIEM_PHG VALUES(4,N'Ha Noi')
INSERT INTO DIADIEM_PHG VALUES(5,N'Vung Tau')
INSERT INTO DIADIEM_PHG VALUES(5,N'Nha Trang')
INSERT INTO DIADIEM_PHG VALUES(5,N'TPHCM')

INSERT INTO THANNHAN VALUES (333445555,N'Quang',N'Nu','05/04/1976',N'Con gai')
INSERT INTO THANNHAN VALUES (333445555,N'Khang',N'Nam','25/10/1973',N'Con trai')
INSERT INTO THANNHAN VALUES (333445555,N'Duong',N'Nu','03/05/1948',N'Vo chong')
INSERT INTO THANNHAN VALUES (987654321,N'Dang',N'Nam','29/02/1932',N'Vo chong')
INSERT INTO THANNHAN VALUES (123456789,N'Duy',N'Nam','01/01/1978',N'Con trai')
INSERT INTO THANNHAN VALUES (123456789,N'Chau',N'Nu','31/12/1978',N'Con gai')
INSERT INTO THANNHAN VALUES (123456789,N'Pphuong',N'Nu','05/05/1957',N'Vo chong')

INSERT INTO DEAN VALUES (1,N'San pham X',N'Vung Tau',5)
INSERT INTO DEAN VALUES (2,N'San pham Y',N'Nha Trang',5)
INSERT INTO DEAN VALUES (3,N'San pham Z',N'TPHCM',5)
INSERT INTO DEAN VALUES (10,N'Tin hoc hoa',N'Ha Noi',4)
INSERT INTO DEAN VALUES (20,N'Cap quang',N'TPHCM',1)
INSERT INTO DEAN VALUES (30,N'dao tao',N'Ha Noi',4)

INSERT INTO PHANCONG VALUES (123456789,1 ,32.5)
INSERT INTO PHANCONG VALUES (123456789,2 ,7.5)
INSERT INTO PHANCONG VALUES (666884444,3 ,40.0)
INSERT INTO PHANCONG VALUES (453453453,1 ,20.0)
INSERT INTO PHANCONG VALUES (453453453,2 ,20.0)
INSERT INTO PHANCONG VALUES (333445555,3,10.0)
INSERT INTO PHANCONG VALUES (333445555,10,10.0)
INSERT INTO PHANCONG VALUES (333445555,20,10.0)
INSERT INTO PHANCONG VALUES (999887777,30,30.0)
INSERT INTO PHANCONG VALUES (999887777,10,10.0)
INSERT INTO PHANCONG VALUES (987987987,10,35.0)
INSERT INTO PHANCONG VALUES (987987987,30,5.0)
INSERT INTO PHANCONG VALUES (987654321,30,20.0)
INSERT INTO PHANCONG VALUES (987654321,20,15.0)
INSERT INTO PHANCONG VALUES (888665555,20,NULL)
drop table NHANVIEN

--mien gia tri
ALTER TABLE NHANVIEN ADD CONSTRAINT C_NV_PHAI CHECK (PHAI IN('Nam','Nu'))
ALTER TABLE NHANVIEN ADD CONSTRAINT C_NV_LUONG CHECK (LUONG>0)
ALTER TABLE THANNHAN ADD CONSTRAINT C_TN_PHAI CHECK (PHAI IN('Nam','Nu'))
ALTER TABLE PHANCONG ADD CONSTRAINT C_PC_THOIGIAN CHECK (THOIGIAN>0)


--cau 1
SELECT TENNV, DCHI AS DIACHI
FROM NHANVIEN NV, PHONGBAN PB
WHERE PHG=MAPHG AND TENPHG=N'Nghien cuu'
--c2
SELECT TENNV, DCHI AS DIACHI
FROM NHANVIEN
WHERE PHG IN (SELECT MAPHG
				FROM PHONGBAN
				WHERE TENPHG='Nghien cuu')

 --CAU 2
 --C2 LOI
 --SELECT  MADA,PHG, TENNV, NGSINH, DCHI
 --FROM NHANVIEN NV, PHONGBAN, DEAN
 --WHERE MANV=TRPHG
	--AND NV.PHG IN (SELECT PHONG
	--				FROM DEAN
	--				WHERE DDIEM_DA='Ha Noi')

--C1
SELECT MADA, PHONG, HONV+TENLOT+TENNV AS HOTEN , DCHI, NGSINH
FROM DEAN DA, PHONGBAN PB, NHANVIEN NV 
WHERE  DA.PHONG=PB.MAPHG AND PB.TRPHG= NV.MANV AND DDIEM_DA='Ha Noi'


--CAU 3

SELECT SODA
FROM PHANCONG PC, NHANVIEN NV
WHERE PC.MA_NVIEN=NV.MANV AND HONV='Dinh'
union
select MADA
FROM DEAN  DA,NHANVIEN NV, PHONGBAN PB
WHERE PB.TRPHG=NV.MANV AND PB.MAPHG=DA.PHONG AND NV.HONV='Dinh'

--cau 4
SELECT HONV,TENNV,MA_NVIEN, COUNT(*) AS SO_LUONG_THAN_NHAN
FROM THANNHAN TN, NHANVIEN NV
WHERE TN.MA_NVIEN =NV.MANV 
GROUP BY MA_NVIEN, TENNV, HONV
HAVING COUNT(*)>2

--CAU 5
SELECT HONV, TENNV
FROM NHANVIEN NV
WHERE  NOT EXISTS(SELECT *
				 FROM THANNHAN TN
				 WHERE NV.MANV=TN.MA_NVIEN)

SELECT HONV, TENNV
FROM NHANVIEN
WHERE MANV IN(SELECT MANV
				FROM NHANVIEN 
				EXCEPT 
				SELECT DISTINCT MA_NVIEN
				FROM THANNHAN)
--C2
SELECT HONV,TENNV
FROM NHANVIEN
WHERE MANV NOT IN (SELECT MA_NVIEN
					FROM THANNHAN)
--CAU 6
SELECT HONV, TENLOT, TENNV
FROM NHANVIEN NV
WHERE NOT EXISTS (SELECT *
					FROM PHANCONG PC
					WHERE NV.MANV=PC.MA_NVIEN)
--CAU 7
SELECT TENDA, MADA
FROM DEAN
WHERE NOT EXISTS (SELECT *
					FROM NHANVIEN NV
					WHERE   EXISTS (SELECT *
									FROM PHANCONG PC
									WHERE NV.MANV=PC.MA_NVIEN))
SELECT *
FROM DEAN
WHERE MADA NOT IN (SELECT SODA
					FROM PHANCONG)
SELECT *
FROM DEAN
WHERE MADA IN (SELECT MADA	
				FROM DEAN
				EXCEPT
				SELECT DISTINCT SODA
				FROM PHANCONG)

--CAU 8
SELECT MANV, HONV+TENLOT+TENNV AS HOTEN
FROM NHANVIEN NV, PHONGBAN PB, THANNHAN TN
WHERE NV.MANV=PB.TRPHG AND PB.TRPHG IN (SELECT MA_NVIEN
										FROM THANNHAN)
GROUP BY MANV,HONV,TENLOT,TENNV 

SELECT *
FROM NHANVIEN
WHERE MANV IN (SELECT TRPHG
				FROM PHONGBAN
				WHERE TRPHG IN (SELECT MA_NVIEN
								FROM THANNHAN))


--CAU 9
SELECT MANV, HONV+TENLOT+TENNV AS HOTEN
FROM NHANVIEN NV, THANNHAN TN
WHERE  NV.MANV NOT IN (SELECT MA_NVIEN
						FROM THANNHAN)
GROUP BY MANV, HONV,TENLOT,TENNV 

SELECT *
FROM NHANVIEN
WHERE MANV IN (SELECT TRPHG
				FROM PHONGBAN
				WHERE TRPHG NOT IN (SELECT MA_NVIEN
								FROM THANNHAN))

--CAU 10
SELECT MANV, HONV+TENLOT+TENNV AS HOTEN
FROM NHANVIEN NV
WHERE  NV.PHG=4 AND NV.MANV IN (SELECT MA_NVIEN
								FROM PHANCONG
								WHERE THOIGIAN>8 AND SODA IN  (SELECT MADA
																FROM DEAN
																WHERE TENDA=N'Dao tao'))



select TENNV
FROM NHANVIEN NV, DEAN DA, PHANCONG PC
WHERE NV.MANV=PC.MA_NVIEN AND PC.SODA=DA.MADA AND PHG=4 AND TENDA='Dao tao' and THOIGIAN >8

DELETE FROM PHANCONG
--CAU 11
SELECT MANV, HONV+TENLOT+TENNV AS HOTEN
FROM NHANVIEN NV
WHERE  NV.PHG=5 AND NV.MANV IN (SELECT MA_NVIEN
								FROM PHANCONG
								WHERE THOIGIAN>=10 AND SODA IN  (SELECT MADA
																FROM DEAN
																WHERE TENDA=N'San pham X'))
--cau 12
SELECT MANV, HONV+TENLOT+TENNV AS HOTEN
FROM NHANVIEN NV, THANNHAN TN
WHERE NV.MANV=TN.MA_NVIEN AND TENNV=TENTN
GROUP BY MANV, HONV,TENLOT,TENNV
--CAU 13
-- NGUYEN THANH TUNG QUAN LI NHUNG AI
SELECT MANV,HONV+TENLOT+TENNV AS HOTEN
FROM NHANVIEN NV 
WHERE MA_NQL IN  (SELECT MANV
				   FROM  NHANVIEN 
				   WHERE  HONV=N'Nguyen' and TENLOT=N'Thanh' AND TENNV=N'Tung' )
-- -- NGUYEN THANH TUNG DO AI  QUAN LI 
--SELECT MANV,HONV+TENLOT+TENNV AS HOTEN
--FROM NHANVIEN 
--WHERE MANV IN (SELECT MANV
--				FROM NHANVIEN
--				WHERE MANV IN (SELECT MA_NQL
--								FROM NHANVIEN
--								WHERE HONV =N'Nguyen' and TENLOT=N'Thanh' AND TENNV=N'Tung'))


SELECT MANV,HONV+TENLOT+TENNV AS HOTEN
FROM NHANVIEN 
WHERE MANV IN (SELECT MA_NQL
								FROM NHANVIEN
								WHERE HONV =N'Nguyen' and TENLOT=N'Thanh' AND TENNV=N'Tung')
--cau 14
SELECT TENDA,SODA,SUM(THOIGIAN) AS TONGGIO
FROM PHANCONG PC, DEAN DA
WHERE DA.MADA=PC.SODA
GROUP BY PC.SODA, DA.TENDA

--CAU 15
SELECT PB.TENPHG, AVG(LUONG) AS LUONGTRUNGBINH
FROM PHONGBAN PB, NHANVIEN NV
WHERE PB.MAPHG=NV.PHG
GROUP BY PB.MAPHG,PB.TENPHG
 
 --CAU 16
 --SELECT HONV+TENLOT+TENNV AS HOTEN
 --FROM NHANVIEN
 --WHERE MANV   IN (SELECT MA_NVIEN
	--			FROM PHANCONG
	--			WHERE  MA_NVIEN   NOT IN (SELECT  MA_NVIEN
	--									FROM PHANCONG
	--									WHERE SODA  NOT IN(SELECT MADA
	--													FROM DEAN
	--													WHERE PHONG =5)))
SELECT HONV, TENNV
FROM NHANVIEN NV
WHERE MANV IN (SELECT PC1.MA_NVIEN
				FROM PHANCONG PC1
				WHERE NOT EXISTS (SELECT*
									FROM DEAN DA
									WHERE PHONG =5 AND NOT EXISTS (SELECT *
																	FROM PHANCONG PC2
																	WHERE PC1.MA_NVIEN=PC2.MA_NVIEN AND P2.SODA=DA.MADA)))

SELECT HONV, TENNV
FROM NHANVIEN NV, DEAN DA, PHANCONG PC
WHERE NV.MANV=PC.MA_NVIEN AND PC.SODA=DA.MADA AND DA.PHONG=5
GROUP BY PC.MA_NVIEN, HONV, TENNV
HAVING COUNT (MA_NVIEN)=(SELECT COUNT (MADA)
						FROM DEAN
						WHERE PHONG=5)
--cau 17
SELECT HONV, TENNV
FROM NHANVIEN NV, DEAN DA, PHANCONG PC
WHERE NV.MANV=PC.MA_NVIEN AND PC.SODA=DA.MADA AND DA.PHONG=5
GROUP BY PC.MA_NVIEN, HONV, TENNV
HAVING COUNT (*)=(SELECT COUNT (*)
						FROM DEAN)



--cau 18
SELECT AVG(LUONG) AS LUONG_TRUNG_BINH_NHAN_VIEN
FROM NHANVIEN
--CAU 19
--cau 20
SELECT HONV, TENLOT, TENNV, SODA
FROM NHANVIEN NV LEFT JOIN PHANCONG PC ON NV.MANV=PC.MA_NVIEN

--CAU 21
SELECT HONV, TENLOT, TENNV, TENDA
FROM NHANVIEN NV LEFT JOIN (PHANCONG PC LEFT JOIN DEAN DA ON PC.SODA=DA.MADA) ON NV.MANV=PC.MA_NVIEN
GROUP BY  TENNV,HONV, TENLOT, TENDA
--CAU 22
SELECT HONV+TENLOT+TENNV AS HOTEN
FROM NHANVIEN	NV, PHONGBAN PB
WHERE NV.MANV=PB.TRPHG AND PHG IN (SELECT PHG 
									FROM NHANVIEN
									GROUP BY PHG
									HAVING COUNT(MANV) >= ALL(SELECT COUNT (MANV)
																FROM NHANVIEN
																GROUP BY PHG))